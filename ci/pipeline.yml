---
release_lock: &release_lock_if_not_success
  on_failure: &release_lock
    put: cats-pool
    params:
      release: cats-pool
  on_error: *release_lock
  on_abort: *release_lock

resources:
# Weekly Trigger
- name: weekly-trigger
  type: time
  icon: clock-outline
  source:
    start: 3:00
    stop: 4:30
    location: America/Los_Angeles
    interval: 168h

# Concourse Tasks
- name: cf-deployment-concourse-tasks
  type: git
  icon: github
  source:
    uri: https://github.com/cloudfoundry/cf-deployment-concourse-tasks.git

- name: runtime-ci
  type: git
  icon: github
  source:
    uri: https://github.com/cloudfoundry/runtime-ci.git
    branch: main

# Releases
- name: cf-smoke-tests-release
  type: git
  icon: github
  source:
    uri: https://github.com/sap-contributions/cf-smoke-tests-release.git
    branch: go-auto-upgrades
    username: ((pat))
    password: x-oauth-basic

- name: cf-smoke-tests-release-trigger
  type: git
  icon: github
  source:
    uri: https://github.com/sap-contributions/cf-smoke-tests-release.git
    branch: go-auto-upgrades
    username: ((pat))
    password: x-oauth-basic
    ignore_paths:
    - releases/**
    - .final_builds/**
    - ci/**
    - .envrc

- name: cf-smoke-tests
  type: git
  icon: github
  source:
    uri: https://github.com/sap-contributions/cf-smoke-tests.git
    branch: go-auto-upgrades
    username: ((pat))
    password: x-oauth-basic

- name: cf-test-helpers
  type: git
  icon: github
  source:
    uri: https://github.com/cloudfoundry/cf-test-helpers
    branch: main

- name: relint-envs
  type: s3
  source:
    bucket: cf-load-test-pipeline
    region_name: eu-central-1
    versioned_file: dev/bbl-state.tar.gz
    access_key_id: ((aws_access_key_id))
    secret_access_key: ((aws_secret_access_key))

- name: cats-pool
  type: pool
  icon: pool
  source:
    uri: https://github.com/sap-contributions/relint-ci-pools.git
    branch: go-auto-upgrades
    pool: cats
    username: ((pat))
    password: x-oauth-basic

# Semantic Version
- name: cf-smoke-tests-version
  type: semver
  source:
    driver: git
    uri: https://github.com/sap-contributions/cf-relint-ci-semver.git
    branch: go-auto-upgrades
    username: ((pat))
    password: x-oauth-basic
    git_user: "CF MEGA BOT <cf-mega@pivotal.io>"
    file: cf-smoke-tests-version

- name: windows2019-stemcell
  type: bosh-io-stemcell
  source:
    name: bosh-aws-xen-hvm-windows2019-go_agent

- name: golang-release
  type: git
  source:
    uri: https://github.com/bosh-packages/golang-release.git

jobs:
- name: bump-deps
  serial: true
  public: true
  plan:
  - in_parallel:
    - get: cf-smoke-tests
    - get: golang-release
      trigger: true
    - get: weekly-trigger
      trigger: true
  - task: bump-deps
    file: golang-release/ci/tasks/shared/bump-deps.yml
    input_mapping:
      input_repo: cf-smoke-tests
    output_mapping:
      output_repo: cf-smoke-tests-updated
    params:
      SOURCE_PATH: .
  - put: cf-smoke-tests
    params:
      repository: cf-smoke-tests-updated
      rebase: true

- name: bump-golang-packages
  serial: true
  public: true
  plan:
  - in_parallel:
    - get: cf-smoke-tests-release
    - get: cf-smoke-tests
    - get: golang-release
      passed: [bump-deps]
      trigger: true
  - task: get-target-go-version
    config:
      platform: linux
      image_resource:
        type: registry-image
        source:
          repository: bosh/golang-release
      inputs:
      - name: cf-smoke-tests
      run:
        path: sh
        args:
        - -ec
        - |
          cd cf-smoke-tests
          go mod edit -json | jq --raw-output .Go > ../version/version
      outputs:
        - name: version
  - load_var: go_version
    file: version/version
  - task: bump-golang-packages
    file: golang-release/ci/tasks/shared/bump-golang-package.yml
    input_mapping:
      input_repo: cf-smoke-tests-release
    output_mapping:
      output_repo: cf-smoke-tests-release-updated
    params:
      PACKAGES: [golang-((.:go_version))-linux, golang-((.:go_version))-windows]
      PRIVATE_YML: |
        ---
        blobstore:
          provider: s3
          options:
            access_key_id: ((aws_access_key_id))
            secret_access_key: ((aws_secret_access_key))
  - put: cf-smoke-tests-release
    params:
      repository: cf-smoke-tests-release-updated
      rebase: true

- name: bump-blobs
  serial: true
  public: true
  plan:
  - get: cf-smoke-tests-release
    trigger: true
    passed: [bump-golang-packages]
  - task: bump-blobs
    config:
      platform: linux
      image_resource:
        type: registry-image
        source:
          repository: cloudfoundry/bosh-cli
      inputs:
      - name: cf-smoke-tests-release
      params:
        GIT_USER_NAME: CI Bot
        GIT_USER_EMAIL: bots@cloudfoundry.org
      run:
        path: /bin/bash
        args:
        - -ec
        - |
          cf_smoke_tests_release_dir="$(pwd)/cf-smoke-tests-release"
          cat > "${cf_smoke_tests_release_dir}/config/private.yml" <<EOF
          ---
          blobstore:
            provider: s3
            options:
              access_key_id: ((aws_access_key_id))
              secret_access_key: ((aws_secret_access_key))
          EOF
          cf_cli_current="$(grep -E 'cf8-cli_.*winx64' "${cf_smoke_tests_release_dir}/config/blobs.yml" |  sed 's/.$//')"
          wget 'https://packages.cloudfoundry.org/stable?release=windows64-exe&version=v8&source=github-rel' --content-disposition
          cf_cli_new="$(ls cf8-cli_*winx64.zip)"
          if [[ "$cf_cli_current" != "$cf_cli_new" ]]; then
            bosh remove-blob "$cf_cli_current" --dir "$cf_smoke_tests_release_dir"
            bosh add-blob "$cf_cli_new" "$cf_cli_new" --dir "$cf_smoke_tests_release_dir"
            bosh upload-blobs --dir "$cf_smoke_tests_release_dir"
          fi
          if [[ $(git -C "$cf_smoke_tests_release_dir" status --porcelain) ]]; then
            git -C "$cf_smoke_tests_release_dir" status
            git config --global user.email "$GIT_USER_EMAIL"
            git config --global user.name "$GIT_USER_NAME"
            git -C "$cf_smoke_tests_release_dir" add "${cf_smoke_tests_release_dir}/config/blobs.yml"
            git -C "$cf_smoke_tests_release_dir" commit -m "Update cf cli to ${cf_cli_new}"
          fi
          cp -r "${cf_smoke_tests_release_dir}/." ./cf-smoke-tests-release-updated/
      outputs:
      - name: cf-smoke-tests-release-updated
  - put: cf-smoke-tests-release
    params:
      repository: cf-smoke-tests-release-updated
      rebase: true

- name: bump-cf-test-helpers
  public: true
  plan:
  - in_parallel:
    - get: cf-smoke-tests
    - get: runtime-ci
    - get: cf-test-helpers
      trigger: true

  - task: run-cf-test-helpers-unit-tests
    file: runtime-ci/tasks/run-cf-test-helpers-unit-tests/task.yml

  - task: bump-cf-test-helpers
    file: runtime-ci/tasks/bump-cf-test-helpers/task.yml
    input_mapping:
      repository: cf-smoke-tests
    params:
      USE_GO_MOD: true
      REPOSITORY: cloudfoundry/cf-smoke-tests

  - put: cf-smoke-tests
    params:
      repository: updated-repository
      rebase: true

- name: bump-cf-smoke-tests
  public: true
  plan:
  - in_parallel:
    - get: cf-smoke-tests-release
    - get: runtime-ci
    - get: cf-smoke-tests
      trigger: true

  - task: bump-cf-smoke-tests
    file: runtime-ci/tasks/bump-cf-smoke-tests/task.yml

  - put: cf-smoke-tests-release
    params:
      repository: updated-cf-smoke-tests-release
      rebase: true

- name: cats-acquire-pool
  public: true
  serial: true
  plan:
  - in_parallel:
    - get: weekly-trigger
      trigger: true
    - get: cf-smoke-tests-release-trigger
      trigger: true
    - get: cf-smoke-tests-release

  - put: cats-pool
    params:
      acquire: true

- name: deploy-updated-smokes
  serial_groups:
  - smoke_tests
  public: true
  <<: *release_lock_if_not_success
  plan:
  - in_parallel:
    - get: cats-pool
      trigger: true
      passed:
      - cats-acquire-pool
    - get: runtime-ci
    - get: cf-deployment-concourse-tasks
    - get: cf-smoke-tests-release-trigger
      passed:
      - cats-acquire-pool
    - get: cf-smoke-tests-release
      passed:
      - cats-acquire-pool
    - get: relint-envs
      params:
        unpack: true
    - get: windows2019-stemcell

  - task: upload-windows2019-stemcell
    file: runtime-ci/tasks/bosh-upload-stemcell/task.yml
    input_mapping:
      bbl-state: relint-envs
      stemcell: windows2019-stemcell
    params:
      BBL_STATE_DIR: bbl-state

  - task: deploy-smoke-tests-errand
    file: runtime-ci/tasks/bosh-deploy-smokes/task.yml
    input_mapping:
      bbl-state: relint-envs
    params:
      BBL_STATE_DIR: bbl-state
      SYSTEM_DOMAIN: cfloadtest.bndl.sapcloud.io
      CREDHUB_ENV_NAME: bosh-cats

- name: run-smokes-errand
  serial_groups:
  - smoke_tests
  public: true
  <<: *release_lock_if_not_success
  plan:
  - in_parallel:
    - get: cats-pool
      trigger: true
      passed:
      - deploy-updated-smokes
    - get: cf-deployment-concourse-tasks
    - get: cf-smoke-tests-release-trigger
      passed:
      - deploy-updated-smokes
    - get: cf-smoke-tests-release
      passed:
      - deploy-updated-smokes
    - get: relint-envs
      params:
        unpack: true

  - task: run-smokes
    file: cf-deployment-concourse-tasks/run-errand/task.yml
    input_mapping:
      bbl-state: relint-envs
    params:
      BBL_STATE_DIR: bbl-state
      DEPLOYMENT_NAME: cf-smoke-tests
      ERRAND_NAME: smoke_tests

  # - task: run-smokes-windows
  #   file: cf-deployment-concourse-tasks/run-errand/task.yml
  #   input_mapping:
  #     bbl-state: relint-envs
  #   params:
  #     BBL_STATE_DIR: bbl-state
  #     DEPLOYMENT_NAME: cf-smoke-tests
  #     ERRAND_NAME: smoke_tests_windows

- name: delete-smokes-deployment
  serial_groups:
  - smoke_tests
  public: true
  <<: *release_lock_if_not_success
  plan:
  - in_parallel:
    - get: cats-pool
      trigger: true
      passed:
      - run-smokes-errand
    - get: cf-deployment-concourse-tasks
    - get: cf-smoke-tests-release-trigger
      passed:
      - run-smokes-errand
    - get: cf-smoke-tests-release
      passed:
      - run-smokes-errand
    - get: relint-envs
      params:
        unpack: true

  - task: delete-smoke-tests-deployment
    file: cf-deployment-concourse-tasks/bosh-delete-deployment/task.yml
    input_mapping:
      bbl-state: relint-envs
    params:
      BBL_STATE_DIR: bbl-state
      DEPLOYMENT_NAME: cf-smoke-tests

  - put: cats-pool
    params:
      release: cats-pool

- name: create-final-release
  serial: true
  public: true
  <<: *release_lock_if_not_success
  plan:
  - in_parallel:
    - get: cf-smoke-tests-release-trigger
      passed:
      - run-smokes-errand
      trigger: true
    - get: cf-smoke-tests-release
      passed:
      - run-smokes-errand
    - get: cf-smoke-tests-version
    - get: runtime-ci

  - task: create-final-release
    file: runtime-ci/tasks/create-final-release/task.yml
    input_mapping:
      release-repo: cf-smoke-tests-release
      semantic-version: cf-smoke-tests-version
    params:
      BLOBS_BUCKET_ACCESS_KEY_ID: ((aws_access_key_id))
      BLOBS_BUCKET_SECRET_KEY: ((aws_secret_access_key))

  - put: cf-smoke-tests-release
    params:
      repository: final-release-repo
      rebase: true
      tag: cf-smoke-tests-version/version

  - put: cf-smoke-tests-version
    params:
      bump: patch
